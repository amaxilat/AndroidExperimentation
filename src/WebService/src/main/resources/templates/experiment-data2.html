<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
    <title th:text="${title}">Leaflet.heat demo</title>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css"/>
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <style type="text/css">* {
        margin: 0;
        padding: 0
    }

    html, body {
        height: 100%;
        width: 100%;
        overflow: hidden
    }

    table {
        height: 100%;
        width: 100%;
        table-layout: static;
        border-collapse: collapse
    }

    #map {
        height: 100%;
        width: 100%
    }

    .content {
        height: 100%
    }</style>
</head>
<body>

<div id="map"></div>

<script src="http://leaflet.github.io/Leaflet.heat/dist/leaflet-heat.js"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    var addressPointsStr = /*[[${addressPoints}]]*/ null;
    var maxString = /*[[${max}]]*/ "{}";
    var max = JSON.parse(maxString);
    var addressPoints = JSON.parse(addressPointsStr);
    console.log(addressPoints);

    var map = L.map('map').setView([38.2908379, 21.7961805], 12);


    //Last in order to be the base layer
    var mapquest = L.tileLayer('http://otile2.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors,Tiles Courtesy of <a href="http://www.mapquest.com/" target="_blank">MapQuest</a>',
        maxZoom: 18,
        opacity: 0.7
    }).addTo(map);

    var markersList = [];
    var circleList = [];
    var polygonListList = [];

    var sensors = [];
    addressPoints.forEach(function (e) {
        for (sensor in e[3]) {
            if (sensor.indexOf("urn:oc") != 0) {
                continue;
            }
            polygonListList[sensor] = [];
            if (sensors.indexOf(sensor) == -1) {
                sensors.push(sensor);
            }
        }
    });

    colors = ['red', 'blue', 'green', 'yellow', 'red', 'blue', 'green', 'yellow', 'red', 'blue', 'green', 'yellow'];

    addressPoints.forEach(function (e) {

        var marker = L.marker([e[0], e[1]]);
        var message = "Values:<br/>" + JSON.stringify(e[3], null, 2);
        marker.bindPopup(message);
        markersList.push(marker);

        for (sensor in e[3]) {
            if (sensor.indexOf("urn:oc") != 0) {
                continue;
            }
            console.log(sensor);

//
//            var circle = L.circle([e[0], e[1]], 10, {
//                color: 'red',
//                fillColor: '#f03',
//                fillOpacity: 0.5
//            });
//            circleList.push(circle);

            var polygon = L.polygon([
                [e[0] - 0.0005, e[1] - 0.0005],
                [e[0] + 0.0005, e[1] - 0.0005],
                [e[0] + 0.0005, e[1] + 0.0005],
                [e[0] - 0.0005, e[1] + 0.0005]
            ], {
                color: colors[sensors.indexOf(sensor)],
                fillColor: colors[sensors.indexOf(sensor)],
                fillOpacity: e[3][sensor] / max[sensor]
            });

            polygonListList[sensor].push(polygon);
        }

    });

    var markersLayer = L.layerGroup(markersList);
    //    var circleLayer = L.layerGroup(circleList);


    var group = new L.featureGroup(markersList);
    map.fitBounds(group.getBounds());


    var baseMaps = {};

    var overlayMaps = {
        "markers": markersLayer
    };
    console.log(sensor);
    for (sensor in sensors) {
        var tempLayer = L.layerGroup(polygonListList[sensors[sensor]]);
        var sss = sensors[sensor].replace("urn:oc:attributeType:", "");

        overlayMaps[sss] = tempLayer;
    }

    L.control.layers(overlayMaps, null).addTo(map);

    /*]]>*/
</script>
</body>
</html>
